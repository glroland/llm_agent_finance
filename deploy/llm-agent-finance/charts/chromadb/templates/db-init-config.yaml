apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "llm-agent-finance.fullname" . }}-init-sql
  labels:
    app.kubernetes.io/part-of: "{{ .Release.Name }}-llm-agent-finance"
    {{- include "llm-agent-finance.labels" . | nindent 4 }}
data:
  create_tables.sql: |+
    \c ai_product_catalog

    CREATE EXTENSION if not exists vector;

    create table if not exists categories
    (
      category_id integer primary key generated by default as identity,
      category_desc varchar(50)
    );

    create table if not exists brands
    (
      brand_id integer primary key generated by default as identity,
      brand_desc varchar(50)
    );

    create table if not exists products
    (
      product_id integer primary key generated by default as identity,
      sku varchar(50) not null,
      brand_id integer not null,
      product_name varchar(100) not null,
      product_desc varchar(1000) not null,
      size varchar(200),
      msrp float,
      category_id integer not null,
      
      CONSTRAINT fk_category
          FOREIGN KEY(category_id) 
            REFERENCES categories(category_id),
      
      CONSTRAINT fk_brand
          FOREIGN KEY(brand_id) 
            REFERENCES brands(brand_id)
    );

    create table if not exists product_embeddings
    (
      product_id integer not null,
      model varchar(75) not null,
      text_segment varchar(5000) not null,
      embedding vector(768) not null,
      
      CONSTRAINT fk_product
          FOREIGN KEY(product_id) 
            REFERENCES products(product_id)
    );

    CREATE INDEX idx_product_embeddings 
              ON product_embeddings USING hnsw (embedding vector_l2_ops);
